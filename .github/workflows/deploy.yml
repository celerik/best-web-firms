name: deploy

on: [push]

jobs:
  deploy_dev:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      
    - name: Github docker login
      run: docker login docker.pkg.github.com -u equisoide -p ${{ secrets.GITHUB_TOKEN }}
      
    - name: Build dev image
      working-directory: ./source
      run: docker build -t docker.pkg.github.com/celerik/best-web-firms-react/bwfr:latest . -f dev.Dockerfile
      
    - name: Publish dev image
      working-directory: ./source
      run: docker push docker.pkg.github.com/celerik/best-web-firms-react/bwfr:latest
      
    - name: Login via azure cli
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Deploy dev website
      uses: azure/webapps-container-deploy@v1
      with:
        app-name: 'bestwebfirms-dev'
        images: 'docker.pkg.github.com/celerik/best-web-firms-react/bwfr:latest'
    
    - name: Azure logout
      run: |
        az logout
      
  deploy_prd:
    if: true == contains(github.event.head_commit.message, '[release]')
    needs: deploy_dev
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      
    - name: Github docker login
      run: docker login docker.pkg.github.com -u equisoide -p ${{ secrets.GITHUB_TOKEN }}
      
    - name: Build prd image
      working-directory: ./source
      run: docker build -t docker.pkg.github.com/celerik/best-web-firms-react/bwfr-prd:latest . -f prd.Dockerfile
      
    - name: Publish prd image
      working-directory: ./source
      run: docker push docker.pkg.github.com/celerik/best-web-firms-react/bwfr-prd:latest
      
    - name: Login via azure cli
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Deploy prd website
      uses: azure/webapps-container-deploy@v1
      with:
        app-name: 'bestwebfirms-prd'
        images: 'docker.pkg.github.com/celerik/best-web-firms-react/bwfr-prd:latest'
    
    - name: Azure logout
      run: |
        az logout
